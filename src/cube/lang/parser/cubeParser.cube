use cube.lang.element
use cube.lang.operator
use cube.lang.cst.cstBuilder
use cube.lang.cst.cstNode
use cube.lang.cst.cstTranslator
use cube.lang.cst.elementTranslator
use cube.lang.parser.elements
use cube.lang.keyword.IF_KEYWORD
use cube.lang.cst.cstNodeType
use cube.lang.tokenizer.symbol
use cube.lang.tokenizer.tokenStream.tokenStream

define cubeParser
  shared
    function parse(text as string) as element = parse(text, new elementTranslator)
    function parseCst(text as string) as cstNode = parse(text, new cstBuilder)

    do
      map.token(IDENTIFIER)
      map.token(NUMBER)
      map.token(CONSTANT_KEYWORD)
      map.operators(Operator.values)
      map.right(DOT, new dotExpressionParser)
      map.right(EQUAL, new assignParser)
      map.left(LEFT_PARENTHESIS, new bracketedTermParser)
      map.right(LEFT_PARENTHESIS, new functionExpressionParser)
      map.left(IF_KEYWORD, new ifExpressionParser)
    end
  end

  internal
    shared
      let map = new parserDefinition[_]

      function parse[T](text as string, translator as cstTranslator[T]) as T =
        new parser(map as parserDefinition[T], translator, tokenStream(text))
          .parse
    end
  end
end